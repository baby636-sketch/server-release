/** 
 * vavilon.js
 * A quick, lightweight and easy-to-use i18n engine for static websites
 * 
 * @version 1.1.0
 * @license MIT
 */
(function () {
    'use strict';

    function get(url, callback) {
        if (url.includes('http')) {
            fetch(url).then(function (response) {
                return response.json();
            }).then(function (data) {
                callback(data);
            })["catch"](function (error) {
                console.log(error);
            });
        }
    }

    var Dictionary =  (function () {
        function Dictionary(url, strings) {
            if (strings === void 0) { strings = {}; }
            this.url = url;
            this.strings = strings;
        }
        Dictionary.prototype.hasString = function (id) {
            return this.strings.hasOwnProperty(id);
        };
        Dictionary.prototype.load = function (cb) {
            var _this = this;
            get(this.url, function (response) {
                _this.strings = response;
                if (cb)
                    cb();
            });
        };
        return Dictionary;
    }());

    function getLocaleCookie() {
        var parts = ('; ' + document.cookie).split('; vavilon-locale=');
        if (parts.length === 2) {
            return parts[1].split(';')[0];
        }
        else {
            return null;
        }
    }
    function setLocaleCookie(locale) {
        var date = new Date();
        date.setTime(date.getTime() + (315360000000));
        var expires = "; expires=" + date.toUTCString();
        document.cookie = "vavilon-locale=" + (locale || '') + expires + "; path=/";
    }

    function getUserLocale() {
        return (getLocaleCookie() || window.navigator.language || window.browserLanguage || window.userLanguage).toLowerCase();
    }
    function getPageLocale() {
        return document.documentElement.lang.toLowerCase();
    }

    var Vavilon =  (function () {
        function Vavilon() {
            this._private_userLocale = getUserLocale();
            this._private_pageLocale = getPageLocale();
            this._private_elements = null;
            this._private_dictionaries = {};
            this._private_pageDict = null;
        }
        Vavilon.prototype.find = function () {
            this._private_elements = document.getElementsByClassName('vavilon');
        };
        Vavilon.prototype.replace = function () {
            var _this = this;
            if (this._private_elements && this._private_pageDict) {
                if (!this._private_dictionaries[this._private_pageLocale]) {
                    this._private_dictionaries[this._private_pageLocale] = new Dictionary(null);
                }
                Array.from(this._private_elements).forEach(function (el) {
                    var strId = el.dataset.vavilon;
                    if (_this._private_dictionaries[_this._private_pageDict].hasString(strId)) {
                        if (!_this._private_dictionaries[_this._private_pageLocale].hasString(strId)) {
                            _this._private_dictionaries[_this._private_pageLocale].strings[strId] = el.innerText.trim();
                        }
                        el.innerText = _this._private_dictionaries[_this._private_pageDict].strings[strId];
                    }
                });
            }
        };
        Vavilon.prototype.addDicts = function () {
            var _this = this;
            Array.from(document.scripts)
                .filter(function (e) { return e.dataset.hasOwnProperty('vavilonDict'); })
                .forEach(function (ds) {
                var dictLocale = ds.dataset.vavilonDict.toLowerCase();
                _this._private_dictionaries[dictLocale] = new Dictionary(ds.src);
            });
        };
        Vavilon.prototype.loadDicts = function (primaryCb) {
            var _this = this;
            Object.keys(this._private_dictionaries)
                .forEach(function (loc) {
                if (loc === _this._private_userLocale || loc.slice(0, 2) === _this._private_userLocale.slice(0, 2) && !_this._private_pageDict) {
                    _this._private_pageDict = loc;
                    _this._private_dictionaries[loc].load(function () {
                        if (Object.keys(_this._private_dictionaries[loc].strings).length === 0) {
                            delete _this._private_dictionaries[loc];
                        }
                        else {
                            _this.pageDictLoaded = true;
                            primaryCb();
                        }
                    });
                }
                else {
                    _this._private_dictionaries[loc].load(function () {
                        if (Object.keys(_this._private_dictionaries[loc].strings).length === 0) {
                            delete _this._private_dictionaries[loc];
                        }
                    });
                }
            });
        };
        Vavilon.prototype.setLocale = function (localeString) {
            if (this._private_dictionaries[localeString]) {
                this._private_pageDict = localeString;
                setLocaleCookie(this._private_pageDict);
                return true;
            }
            else if (this._private_dictionaries[localeString.slice(0, 2)]) {
                this._private_pageDict = localeString.slice(0, 2);
                setLocaleCookie(this._private_pageDict);
                return true;
            }
            return false;
        };
        Vavilon.prototype.getTranslation = function (strId, arg) {
            if (this._private_pageDict) {
                if (!this._private_dictionaries[this._private_pageDict]) {
                    this._private_dictionaries[this._private_pageDict] = new Dictionary(null);
                }
                var translated = this._private_dictionaries[this._private_pageDict].strings[strId] || strId;
                if (translated.includes("%s")) {
                    return translated.replace('%s', arg || '?');
                }
                else {
                    return translated;
                }
            }
            if (strId.includes("%s")) {
                return strId.replace('%s', arg || '?');
            }
            else {
                return strId;
            }
        };
        return Vavilon;
    }());

    var vavilon = new Vavilon();
    var pageLoaded = false;
    vavilon.addDicts();
    vavilon.loadDicts(function () {
        if (pageLoaded) {
            vavilon.replace();
        }
    });
    function initialTranslation() {
        vavilon.find();
        pageLoaded = true;
        if (vavilon.pageDictLoaded) {
            vavilon.replace();
        }
        else {
            console.log('No dictionary loaded');
        }
    }
    document.addEventListener("DOMContentLoaded", initialTranslation);
    window.setLang = function (localeString) {
        localeString = localeString.toLowerCase();
        var changeSuccessful = vavilon.setLocale(localeString);
        if (changeSuccessful) {
            vavilon.replace();
        }
    };
    window.___i18n = function (stringKey, arg) {
        return vavilon.getTranslation(stringKey, arg);
    };

}());
